<%
def to_config(list)
  return '' unless list

  list.inject([]) do |out, obj|
    out + obj.map do |(name, config)|
      chunk = []
      chunk << "  #{name} {"
      config.sort.each do |key, value|
        if value.kind_of?(Hash)
          value.each_pair do |k, v|
            chunk << "    #{key} => #{[k,v].inspect}"
          end
        else
          chunk << "    #{key} => #{value.inspect}"
        end
      end
      chunk << '  }'
      chunk.join("\n")
    end
  end.join("\n\n")
end

# Force the type to the index type
inputs = @config['inputs'].inject([]) do |inputs_, input|
  raise "Woops, more than one key" if input.keys.size > 1
  key = input.keys.first
  input = input[key].dup
  input['type'] = @name
  inputs_ + [{key => input}]
end

-%>
input {
<%= to_config(inputs) %>
}

filter {
<%= to_config(@config['filters']) %>
}

output {
<%= to_config(@config['outputs']) %>
  elasticsearch {
    embedded => false
    cluster => "<%= node['logstash']['elasticsearch']['cluster']['name'] %>"
  }
}
